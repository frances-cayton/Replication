---
title: "Distance Visualizations and Model Testing"
output: html_document
---

```{r, results = 'hide', message = FALSE}
library(foreign)
library(stargazer)
library(arm)
library(rms)
library(msm)
library(systemfit)
library(xtable)
library(gtools)
library(multiwayvcov)
library(numDeriv)
library(interplot)
library(modmarg)
library(tidyverse)
library(stats)
library(haven)
library(systemfit)
library(nnet)
library(sjmisc)
library(maptools)
library(rgeos)
library(Imap)
library(spatstat)
library(StatMeasures)
library(sandwich)
```

```{r}
load("datawork.RData")
```

```{r}
#reclassifying municipality and district as factor variables
table$id_mun<-factor(table$id_mun)
table$id_dist<-factor(table$id_dist)
```

The original model: 

```{r}
benchmarkPRI.1.proximity <- lm( EPNa ~ proximity*PRIstr*highTURNOUT+
                        proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPRD.1.proximity <- lm( AMLOa ~ proximity*PRIstr*highTURNOUT+
                        proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.proximity <- lm( JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.proximity <- lm( PART ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)
```

Now with pure distance:
```{r}
benchmarkPRI.1.distance <- lm( EPNa ~ distance*PRIstr*highTURNOUT+
                        distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1.distance <- lm( AMLOa ~ distance*PRIstr*highTURNOUT+
                        distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.distance <- lm( JVMa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.distance <- lm( PART ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```


Making a quantile model:
```{r}
seq <- quantile(table$distance)
seq[5] <- 20

table$Distance.Quant <- cut(table$distance, breaks = seq)

table$Distance.Quant <- as.factor(table$Distance.Quant)

benchmarkPRI.1.Quantile <- lm( EPNa ~ Distance.Quant*PRIstr*highTURNOUT+
                        Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1.Quantile <- lm(AMLOa ~ Distance.Quant*PRIstr*highTURNOUT+
                        Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.Quantile <- lm( JVMa ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.Quantile <- lm( PART ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```

Finally, a model with coarsened deciles:
```{r}
seq <- quantile(table$distance, prob = seq(0, 1, length = 11))

seq[11] <- 20
table$Distance.Decile <- cut(table$distance, breaks = seq)

table$Distance.Decile <- as.factor(table$Distance.Decile)

benchmarkPRI.1.Decile <- lm( EPNa ~ Distance.Decile*PRIstr*highTURNOUT+
                        Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1.Decile <- lm(AMLOa ~ Distance.Decile*PRIstr*highTURNOUT+
                        Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.Decile <- lm( JVMa ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.Decile <- lm( PART ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```

Calculating RSEs for each model: 
```{r}
covBMprox <- cluster.vcov(benchmarkPRI.1.proximity, table$id_dist)
covBMdist <- cluster.vcov(benchmarkPRI.1.distance, table$id_dist)
covBMquantiles <- cluster.vcov(benchmarkPRI.1.Quantile, table$id_dist)
covBMdeciles <- cluster.vcov(benchmarkPRI.1.Decile, table$id_dist)
```

### Table 1 - All Distance Models in Comparison - Including as an appendix but not in the text

```{r}
stargazer(coeftest(benchmarkPRI.1.proximity, covBMprox), coeftest(benchmarkPRI.1.distance, covBMdist), coeftest(benchmarkPRI.1.Quantile, covBMquantiles), coeftest(benchmarkPRI.1.Decile, covBMdeciles),style = "qje", star.cutoffs = c(0.05, 0.01, 0.001), type = "text", digits=3,
          covariate.labels = c("Proximity", "PRI stronghold", "High Mobilization", "PRD stronghold","PAN stronghold", "PRI 2009", "PRD2009", "PAN2009", "Turnout 2009", "Population Log", "Population over 18 ",
                               "Population over 65", "Area", "Density", "Indigenous","Catholic","Nonreligious","Education","College degree","Illiteracy","Inhabitants per house","Population in the labor market",
                               "Female population in the labor market", "No insurance","Female head of household","Inhabitants per room", "Dirt floor", "All services", "No services", "Car", "Mobile phone", "Internet", "ACULCO" , "ALMOLOYA DE JUAREZ " , 
                               "ALMOLOYA DEL RIO" , "AMANALCO" , "AMECAMECA" , "APAXCO" , "ATENCO" , "ATIZAPAN" , "ATIZAPAN DE ZARAGOZA" , "AXAPUSCO" , "AYAPANGO" , "CALIMAYA" , "CAPULHUAC" , "CHALCO" , "CHAPULTEPEC" ,
                               "CHIAUTLA" , "CHICOLOAPAN" , "CHICONCUAC" , "CHIMALHUACAN" , "COACALCO DE BERRIOZABAL" , "COCOTITLAN" , "COYOTEPEC" , "CUAUTITLAN" , "CUAUTITLAN IZCALLI" , "ECATEPEC DE MORELOS" , "HUEHUETOCA",
                               "HUEYPOXTLA" , "HUIXQUILUCAN" , "ISIDRO FABELA" , "IXTAPALUCA" , "IXTLAHUACA" , "JALTENCO" , "JILOTEPEC" , "JILOTZINGO" , "JIQUIPILCO" , "JOCOTITLAN" , "JOQUICINGO" , "JUCHITEPEC" , "LA PAZ" ,
                               "LERMA" , "MELCHOR OCAMPO" , "METEPEC" , "MEXICALTZINGO" , "MORELOS" , "NAUCALPAN DE JUAREZ" , "NEXTLALPAN" , "NEZAHUALCOYOTL" , "NICOLAS ROMERO" , "OCOYOACAC" , "OCUILAN" , "OTUMBA" , 
                               "OTZOLOTEPEC" , "PAPALOTLA" , "POLOTITLAN" , "RAYON" , "SAN ANTONIO LA ISLA" , "SAN FELIPE DEL PROGRESO" , "SAN MARTIN DE LAS PIRAMIDES" , "SAN MATEO ATENCO" , "SOYANIQUILPAN DE JUAREZ" , "TECAMAC" ,
                               "TEMAMATLA" , "TEMASCALAPA" , "TEMOAYA" , "TENANGO DEL AIRE" , "TENANGO DEL VALLE" , "TEOLOYUCAN" , "TEOTIHUACAN" , "TEPETLAOXTOC" , "TEPOTZOTLAN" , "TEQUIXQUIAC" , "TEXCALYACAC" , "TEXCOCO" , "TEZOYUCA" ,
                               "TIANGUISTENCO" , "TLALMANALCO" , "TLALNEPANTLA DE BAZ" , "TOLUCA" , "TONANITLA" , "TULTEPEC" , "TULTITLAN" , "VALLE DE CHALCO SOLIDARIDAD" , "VILLA DE ALLEND" , "VILLA DEL CARBON" , "VILLA VICTORIA" , 
                               "XALATLACO" , "XONACATLAN" , "ZINACANTEPEC" , "ZUMPANGO" , "ALVARO OBREGON" , "AZCAPOTZALCO" , "BENITO JUAREZ" , "COYOACAN" , "CUAJIMALPA DE MORELOS" , "CUAUHTEMOC" , "GUSTAVO A. MADERO" , "IZTACALCO" , 
                               "IZTAPALAPA" , "MAGDALENA CONTRERAS" , "MIGUEL HIDALGO" , "MILPA ALTA" , "TLAHUAC" , "TLALPAN" , "VENUSTIANO CARRANZA" , "XOCHIMILCO"))


```


Noting the lack of high turnout & PRD observations (Tables 1 & 2  in te paper) 
```{r}
table %>% filter(highTURNOUT == 1 & PRDstr == 1) -> subset
nrow(subset)
summary(subset$Distance.Quant)
summary(subset$Distance.Decile)
```


## Making plots: 

### First, the initial proximity chart
```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

at.prox <- seq(1/20, 1/2.5, 1/1000)
marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000),  cofint=.95)

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRI<-data.frame(cbind(at.prox, mean, upper, lower))
dataPRI$distance<-(1/dataPRI$at.prox)


#same for AMLO
g <- glm(AMLOa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000), cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRD<-data.frame(cbind(at.prox, mean, upper, lower))
dataPRD$distance<-(1/dataPRD$at.prox)


g <- glm(JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("proximity"), 
           type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000),cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPAN<-data.frame(cbind(at.prox, mean, upper, lower))
dataPAN$distance<-(1/dataPAN$at.prox)

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))

datasim$dv<-NA
datasim$dv[1:351]<-"Pena Nieto" # Chengyu: I have to change the name to Pena
datasim$dv[352:702]<-"López Obrador"
datasim$dv[703:1053]<-"Vázquez Mota"
```


```{r}
originalprox <- ggplot()+
  geom_line(data=datasim, aes(x=distance, y=mean,  linetype=dv))+
  geom_ribbon(data=datasim, aes(x=distance,  ymin=lower, 
                      ymax=upper, fill=dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)") +
  xlab("Distance to Soriana (km)")+xlim(2.5,20)+ylim(0,50)+ 
  ggtitle("Original Author Plot - Proximity") +
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size= 12),
        axis.title=element_text(size= 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5))

ggsave("originalprox.jpg")
```


## Distance plot
```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

at.dist <- seq(0, 20, .5)
marg<-marg(mod = g, var_interest = c("distance"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(0, 20, by = .5),  cofint=.95)

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRI<-data.frame(cbind(at.dist, mean, upper, lower))


#same for AMLO
g <- glm(AMLOa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("distance"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(0, 20, by = .5), cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRD<-data.frame(cbind(at.dist, mean, upper, lower))


g <- glm(JVMa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("distance"), 
           type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(0, 20, by = .5),cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPAN<-data.frame(cbind(at.dist, mean, upper, lower))

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))
```


```{r}
datasim$dv<-NA
datasim$dv[1:41]<-"Pena Nieto"
datasim$dv[42:82]<-"López Obrador"
datasim$dv[83:123]<-"Vázquez Mota"
```


```{r}
distance <- ggplot()+
  geom_line(data=datasim, aes(x=at.dist, y=mean,  linetype=dv))+
  geom_ribbon(data=datasim, aes(x=at.dist,  ymin=lower, 
                      ymax=upper, fill=dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+ 
  ggtitle("Pure Distance") +
  xlab("Distance to Soriana (km)")+xlim(2.5, 20)+ylim(0,50)+ 
 scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = .5))

ggsave("distance.jpg")
```


So, the `PRDstr*highTURNOUT` interaction is creating near multicollinearity here.  I removed the `Distance*highTurnout*PRDstr` interaction for now, as we cannot estimate the models with this problem.

###For the Quantiles

```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Quant"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

seq <- as.numeric(quantile(table$distance)[-1])
seq[4] <- 20
dataPRI<-data.frame(cbind(seq, mean, upper, lower))

#same for AMLO
g <- glm(AMLOa ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Quant"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


seq <- as.numeric(quantile(table$distance)[-1])
seq[4] <- 20
dataPRD<-data.frame(cbind(seq, mean, upper, lower))


g <- glm(JVMa ~ Distance.Quant*PRIstr*highTURNOUT+PRDstr+Distance.Quant*PANstr*highTURNOUT+PRDstr+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Quant"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


seq <- as.numeric(quantile(table$distance)[-1])
seq[4] <- 20
dataPAN<-data.frame(cbind(seq, mean, upper, lower))


datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))

datasim$dv<-NA
datasim$dv[1:4]<-"Pena Nieto"
datasim$dv[5:8]<-"López Obrador"
datasim$dv[9:12]<-"Vázquez Mota"
```


```{r}
datasim %>%
ggplot()+
  geom_line(aes(x=seq, y=mean,  linetype=dv))+
 geom_ribbon(aes(x= as.numeric(seq),  ymin= lower,  ymax= upper, fill= dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+
  ggtitle("Coarsened Quantiles") +
  xlab("Distance to Soriana (km)")+xlim(1.5, 20)+ylim(0,50)+ 
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = .5)) -> quantiles

ggsave("quantiles.jpg")
```


###For the Deciles

```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PANstr+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Decile"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

seq <- as.numeric(quantile(table$distance)[-1])

seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
seq <- seq[-1]
seq[10] <- 20
table$Distance.Decile <- cut(table$distance, breaks = seq)

dataPRI<-data.frame(cbind(seq, mean, upper, lower))

#same for AMLO
g <- glm(AMLOa ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PANstr+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Decile"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
seq <- seq[-1]
seq[10] <- 20
dataPRD<-data.frame(cbind(seq, mean, upper, lower))


g <- glm(JVMa ~ Distance.Decile*PRIstr*highTURNOUT+PRDstr+Distance.Decile*PANstr+PRDstr+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Decile"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
seq <- seq[-1]
seq[10] <- 20
dataPAN<-data.frame(cbind(seq, mean, upper, lower))

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))
```


```{r}
datasim$dv<-NA
datasim$dv[1:10]<-"Pena Nieto"
datasim$dv[11:20]<-"López Obrador"
datasim$dv[21:30]<-"Vázquez Mota"
```


```{r}
datasim %>%
ggplot()+
  geom_line(aes(x=seq, y=mean,  linetype=dv))+
 geom_ribbon(aes(x= as.numeric(seq),  ymin= lower,  ymax= upper, fill= dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+
  xlab("Distance to Soriana (km)")+xlim(1, 20)+ylim(0,50)+ 
  ggtitle("Coarsened Deciles") +
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = .5)) -> deciles

ggsave("deciles.jpg")
```

Checking Standard Errors:
```{r}
library(sandwich)
tail(coeftest(benchmarkPRI.1.proximity, vcov = vcovHC(benchmarkPRI.1.proximity, type="HC1")))
tail(coeftest(benchmarkPRI.1.proximity))

tail(coeftest(benchmarkPRI.1.distance, vcov = vcovHC(benchmarkPRI.1.distance,type="HC1")))
tail(coeftest(benchmarkPRI.1.distance))

tail(coeftest(benchmarkPRI.1.Quantile, vcov = vcovHC(benchmarkPRI.1.Quantile,type="HC1")), n = 30)
tail(coeftest(benchmarkPRI.1.Quantile), n = 30)


tail(coeftest(benchmarkPRI.1.Decile, vcov = vcovHC(benchmarkPRI.1.Decile,type="HC1")), n = 50)
tail(coeftest(benchmarkPRI.1.Decile), n = 50)
```


```{r}
model <- c("Proximity", "Distance", "Quantile [2.56, 4.78)", "Decile(2.57, 3.12]")
RSE <- as.numeric(c(8.7923, 0.02712359,0.7134083, 2.8442492))
CSE <- as.numeric(c(6.6196123, 0.01653587, 3.0606704, 3.6399181))
coefficient <- as.numeric(c(17.2593617, -0.049846400, 2.85526845, 4.203151))
upperRSE <- coefficient + (1.96*RSE)
lowerRSE <- coefficient - (1.96*RSE)
upperCSE <- coefficient + (1.96*CSE)
lowerCSE <- coefficient - (1.96*CSE)


df <- as.data.frame(cbind(model, RSE, CSE, coefficient, upperRSE, lowerRSE, upperCSE, lowerCSE))
df <- pivot_longer(df, cols = 2:3)
df$sampleNum <- 1:8
```



```{r}
labels <- seq(-1, 30, length.out=10)
```


```{r}
df %>%
  ggplot(aes(x = coefficient, y = model)) +
  geom_point(aes(x = coefficient)) +
  geom_errorbarh(aes(xmin=lowerRSE,xmax=upperRSE, color = "red")) + 
  geom_errorbarh(aes(xmin=lowerCSE,xmax=upperCSE, color= "blue")) + 
  scale_color_discrete(name = "Legend", labels = c("Robust", "Classical")) +
 xlab("Coefficient") + theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("High Proximity*Distance Measure*PRD Stronghold Estimates") +
  ylab("Model") 
    


```



