---
title: "Distance Visualizations and Model Testing"
output: html_document
---

```{r, results = 'hide', message = FALSE}
library(foreign)
library(stargazer)
library(arm)
library(rms)
library(msm)
library(systemfit)
library(xtable)
library(gtools)
library(multiwayvcov)
library(numDeriv)
library(interplot)
library(modmarg)
library(tidyverse)
library(stats)
library(haven)
library(systemfit)
library(nnet)
library(sjmisc)
library(maptools)
library(rgeos)
library(Imap)
library(spatstat)
library(StatMeasures)
```

```{r}
load("datawork.RData")
```


```{r}
seq <- c(.5,1,2,5,15,20)
table$Distance.Cat <- cut(table$distance, breaks = seq)
```

```{r}
table$Distance.Cat <- as.factor(table$Distance.Cat)
```


Re-estimating the model using the coarsened distance and classical standard errors

```{r}
#reclassifying municipality and district as factor variables
table$id_mun<-factor(table$id_mun)
table$id_dist<-factor(table$id_dist)
```


```{r}
benchmarkPRI.1 <- lm( EPNa ~ Distance.Cat*PRIstr*highTURNOUT+
                        Distance.Cat*PRDstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1 <- lm( AMLOa ~ Distance.Cat*PRIstr*highTURNOUT+
                        Distance.Cat*PRDstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1 <- lm( JVMa ~ Distance.Cat*PRIstr*highTURNOUT+Distance.Cat*PRDstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1 <- lm( PART ~ Distance.Cat*PRIstr*highTURNOUT+Distance.Cat*PRDstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```

```{r}
benchmarkPRI.1.proximity <- lm( EPNa ~ proximity*PRIstr*highTURNOUT+
                        proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPRD.1.proximity <- lm( AMLOa ~ proximity*PRIstr*highTURNOUT+
                        proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.proximity <- lm( JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.proximity <- lm( PART ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)
```


```{r}
benchmarkPRI.1.distance <- lm( EPNa ~ distance*PRIstr*highTURNOUT+
                        distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1.distance <- lm( AMLOa ~ distance*PRIstr*highTURNOUT+
                        distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.distance <- lm( JVMa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.distance <- lm( PART ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```


Making a quantile model:
```{r}
seq <- quantile(table$distance)
seq[5] <- 20
```


```{r}
table$Distance.Quant <- cut(table$distance, breaks = seq)
```

```{r}
table$Distance.Quant <- as.factor(table$Distance.Quant)
```

```{r}

benchmarkPRI.1.Quantile <- lm( EPNa ~ Distance.Quant*PRIstr*highTURNOUT+
                        Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1.Quantile <- lm(AMLOa ~ Distance.Quant*PRIstr*highTURNOUT+
                        Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.Quantile <- lm( JVMa ~ Distance.Cat*PRIstr*highTURNOUT+Distance.Cat*PRDstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.Quantile <- lm( PART ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PRDstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```

Finally, a model with deciles:

Making a quantile model:
```{r}
seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
```


```{r}
seq[11] <- 20
table$Distance.Decile <- cut(table$distance, breaks = seq)
```

```{r}
table$Distance.Decile <- as.factor(table$Distance.Decile)
```

```{r}

benchmarkPRI.1.Decile <- lm( EPNa ~ Distance.Decile*PRIstr*highTURNOUT+
                        Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+ 
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


#The same model but testing for other parties: 

benchmarkPRD.1.Decile <- lm(AMLOa ~ Distance.Decile*PRIstr*highTURNOUT+
                        Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)


benchmarkPAN.1.Decile <- lm( JVMa ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=table, x=TRUE, y=TRUE)



benchmarkPART.1.Decile <- lm( PART ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PRDstr*highTURNOUT+Distance.Decile*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=table, x=TRUE, y=TRUE)

```


### Table 1

```{r}
knitr::kable(broom::tidy(benchmarkPRI.1))
knitr::kable(broom::tidy(benchmarkPRI.1.proximity))
knitr::kable(broom::tidy(benchmarkPRI.1.distance))
knitr::kable(broom::tidy(benchmarkPRI.1.Quantile))
knitr::kable(broom::tidy(benchmarkPRI.1.Decile))
```

```{r}
table %>% filter(highTURNOUT == 1 & PRDstr == 1) -> subset
nrow(subset)
summary(subset$Distance.Quant)
```


## Making plots: 

### First, the initial proximity chart
```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

at.prox <- seq(1/20, 1/2.5, 1/1000)
marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000),  cofint=.95)

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRI<-data.frame(cbind(at.prox, mean, upper, lower))
dataPRI$distance<-(1/dataPRI$at.prox)


#same for AMLO
g <- glm(AMLOa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000), cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRD<-data.frame(cbind(at.prox, mean, upper, lower))
dataPRD$distance<-(1/dataPRD$at.prox)


g <- glm(JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("proximity"), 
           type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000),cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPAN<-data.frame(cbind(at.prox, mean, upper, lower))
dataPAN$distance<-(1/dataPAN$at.prox)

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))

datasim$dv<-NA
datasim$dv[1:351]<-"Pena Nieto" # Chengyu: I have to change the name to Pena
datasim$dv[352:702]<-"López Obrador"
datasim$dv[703:1053]<-"Vázquez Mota"
```


```{r}
originalprox <- ggplot()+
  geom_line(data=datasim, aes(x=distance, y=mean,  linetype=dv))+
  geom_ribbon(data=datasim, aes(x=distance,  ymin=lower, 
                      ymax=upper, fill=dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)") +
  xlab("Distance to Soriana (km)")+xlim(2.5,20)+ylim(0,50)+ 
  ggtitle("Original Author Plot - Proximity") +
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size= 12),
        axis.title=element_text(size= 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5))

ggsave("originalprox.jpg")
```

## Distance plot
```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

at.dist <- seq(0, 20, .5)
marg<-marg(mod = g, var_interest = c("distance"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(0, 20, by = .5),  cofint=.95)

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRI<-data.frame(cbind(at.dist, mean, upper, lower))


#same for AMLO
g <- glm(AMLOa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("distance"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(0, 20, by = .5), cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRD<-data.frame(cbind(at.dist, mean, upper, lower))


g <- glm(JVMa ~ distance*PRIstr*highTURNOUT+distance*PRDstr*highTURNOUT+distance*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("distance"), 
           type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,],
           at_var_interest = seq(0, 20, by = .5),cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPAN<-data.frame(cbind(at.dist, mean, upper, lower))

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))
```


```{r}
datasim$dv<-NA
datasim$dv[1:41]<-"Pena Nieto"
datasim$dv[42:82]<-"López Obrador"
datasim$dv[83:123]<-"Vázquez Mota"
```


```{r}
distance <- ggplot()+
  geom_line(data=datasim, aes(x=at.dist, y=mean,  linetype=dv))+
  geom_ribbon(data=datasim, aes(x=at.dist,  ymin=lower, 
                      ymax=upper, fill=dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+ 
  ggtitle("Pure Distance") +
  xlab("Distance to Soriana (km)")+xlim(2.5, 20)+ylim(0,50)+ 
 scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = .5))

ggsave("distance.jpg")
```


So, the `PRDstr*highTURNOUT` interaction is creating near multicollinearity here.  I removed the `Distance*highTurnout*PRDstr` interaction for now, but will come back and we can try to fix it. Chengyu, if you can figure it out let me know. 


```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ Distance.Cat*PRIstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+Distance.Cat*highTURNOUT +PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Cat"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'
Distance.Cat <- c(.5,1,2,5,15,20)

dataPRI<-data.frame(cbind(Distance.Cat, mean, upper, lower))


#same for AMLO
g <- glm(AMLOa ~ Distance.Cat*PRIstr*highTURNOUT+Distance.Cat*PANstr*highTURNOUT+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Cat"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


dataPRD<-data.frame(cbind(Distance.Cat, mean, upper, lower))


g <- glm(JVMa ~ Distance.Cat*PRIstr*highTURNOUT+PRDstr+Distance.Cat*PANstr*highTURNOUT+PRDstr+    
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Cat"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


dataPAN<-data.frame(cbind(Distance.Cat, mean, upper, lower))

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))
```


```{r}
datasim$dv<-NA
datasim$dv[1:7]<-"Pena Nieto"
datasim$dv[8:14]<-"López Obrador"
datasim$dv[15:21]<-"Vázquez Mota"
```

```{r}
coarsened <- ggplot()+
  geom_line(data=datasim, aes(x=Distance.Cat, y=mean,  linetype=dv))+
  geom_ribbon(data=datasim, aes(x=Distance.Cat,  ymin=lower, 
                      ymax=upper, fill=dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+
  ggtitle("Coarsened Distance") +
  xlab("Distance to Soriana (km)")+xlim(0, 100)+ylim(0,50)+ 
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=18),
        legend.text = element_text(size = 18),
        plot.title = element_text(hjust = .5))

ggsave("coarsened.jpg")
```




###For the Quantiles

```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Quant"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

seq <- as.numeric(quantile(table$distance)[-1])
seq[4] <- 20
dataPRI<-data.frame(cbind(seq, mean, upper, lower))

#same for AMLO
g <- glm(AMLOa ~ Distance.Quant*PRIstr*highTURNOUT+Distance.Quant*PANstr*highTURNOUT+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Quant"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


seq <- as.numeric(quantile(table$distance)[-1])
seq[4] <- 20
dataPRD<-data.frame(cbind(seq, mean, upper, lower))


g <- glm(JVMa ~ Distance.Quant*PRIstr*highTURNOUT+PRDstr+Distance.Quant*PANstr*highTURNOUT+PRDstr+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Quant"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


seq <- as.numeric(quantile(table$distance)[-1])
seq[4] <- 20
dataPAN<-data.frame(cbind(seq, mean, upper, lower))


datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))

datasim$dv<-NA
datasim$dv[1:4]<-"Pena Nieto"
datasim$dv[5:8]<-"López Obrador"
datasim$dv[9:12]<-"Vázquez Mota"
```


```{r}
datasim %>%
ggplot()+
  geom_line(aes(x=seq, y=mean,  linetype=dv))+
 geom_ribbon(aes(x= as.numeric(seq),  ymin= lower,  ymax= upper, fill= dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+
  ggtitle("Coarsened Quantiles") +
  xlab("Distance to Soriana (km)")+xlim(1.5, 20)+ylim(0,50)+ 
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=18),
        legend.text = element_text(size = 18),
        plot.title = element_text(hjust = .5)) -> quantiles

ggsave("quantiles.jpg")
```


###For the Deciles

```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PANstr+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Decile"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

seq <- as.numeric(quantile(table$distance)[-1])

seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
seq <- seq[-1]
seq[10] <- 20
table$Distance.Decile <- cut(table$distance, breaks = seq)

dataPRI<-data.frame(cbind(seq, mean, upper, lower))

#same for AMLO
g <- glm(AMLOa ~ Distance.Decile*PRIstr*highTURNOUT+Distance.Decile*PANstr+PRDstr+
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Decile"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'


seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
seq <- seq[-1]
seq[10] <- 20
dataPRD<-data.frame(cbind(seq, mean, upper, lower))


g <- glm(JVMa ~ Distance.Decile*PRIstr*highTURNOUT+PRDstr+Distance.Decile*PANstr+PRDstr+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=table, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("Distance.Decile"), type = 'levels', data=table[table$PRDstr==1 & table$highTURNOUT==1,])

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

seq <- quantile(table$distance, prob = seq(0, 1, length = 11))
seq <- seq[-1]
seq[10] <- 20
dataPAN<-data.frame(cbind(seq, mean, upper, lower))

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))
```


```{r}
datasim$dv<-NA
datasim$dv[1:10]<-"Pena Nieto"
datasim$dv[11:20]<-"López Obrador"
datasim$dv[21:30]<-"Vázquez Mota"
```


```{r}
datasim %>%
ggplot()+
  geom_line(aes(x=seq, y=mean,  linetype=dv))+
 geom_ribbon(aes(x= as.numeric(seq),  ymin= lower,  ymax= upper, fill= dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+
  xlab("Distance to Soriana (km)")+xlim(1, 20)+ylim(0,50)+ 
  ggtitle("Coarsened Deciles") +
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=18),
        legend.text = element_text(size = 18),
        plot.title = element_text(hjust = .5)) -> deciles

ggsave("deciles.jpg")
```

Checking Standard Errors:
```{r}
library(sandwich)
tail(coeftest(benchmarkPRI.1, vcov = vcovHC(benchmarkPRI.1,type="HC1")))
tail(coeftest(benchmarkPRI.1))

tail(coeftest(benchmarkPRI.1.proximity, vcov = vcovHC(benchmarkPRI.1.proximity,type="HC1")))
tail(coeftest(benchmarkPRI.1.proximity))

head(coeftest(benchmarkPRI.1.distance, vcov = vcovHC(benchmarkPRI.1.distance,type="HC1")))
head(coeftest(benchmarkPRI.1.distance))

head(coeftest(benchmarkPRI.1.Quantile, vcov = vcovHC(benchmarkPRI.1.Quantile,type="HC1")))
head(coeftest(benchmarkPRI.1.Quantile))


head(coeftest(benchmarkPRI.1.Decile, vcov = vcovHC(benchmarkPRI.1.Decile,type="HC1")))
head(coeftest(benchmarkPRI.1.Decile))
```

```{r}
cbind(benchmarkPRI.Quantile$residuals, benchmarkPRI.1.proximity$residuals)
```


```{r}
knitr::kable(broom::tidy(cbind(benchmarkPRI.1$residuals, benchmarkPRI.1.proximity$residuals))
```



