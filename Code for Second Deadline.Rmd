---
title: "Replication Code for Second Deadline"
output: html_document
---

```{r}
rm(list=ls(all=TRUE))
library(foreign)
library(ggplot2)
library(stargazer)
library(arm)
library(rms)
library(msm)
library(systemfit)
library(xtable)
library(gtools)
library(multiwayvcov)
library(numDeriv)
library(interplot)
library(modmarg)
library(tidyverse)
library(stats)
library(haven)
library(systemfit)
library(nnet)

load("datawork.RData")
```

# Replication of Figure 1 (Chengyu)

```{r data_figure_1}

base <- read_stata("./rawdata/Base nacional de la ENVUD para trabajar por estado.dta")

base_2 <- base[base$estado == 9 | base$estado == 15,]

base_2$sectionID <- paste(base_2$estado, base_2$seccion, sep = " _ ")

precinct <- read_stata("./rawdata/precinctdata.dta")

base_3 <- merge(base_2, precinct, by = "sectionID")

base_3$gender <- base_3$genero
base_3$age <- base_3$edad
base_3$sec <- base_3$P15

base_3[base_3$sec==0,]$sec <- 0.6

#30b.- (SI DICE SÍ) ¿A cuántos grupos u organizaciones de ese tipo pertenece usted? (ANOTAR EL NUMERO DIRECTO; 0=NINGUNO; 99=NS/NC)
base_3$belongparty <- base_3$'P30_4'
base_3$belongunion <- base_3$'P30_5'
base_3$belongreligiousgroup <- base_3$'P30_7'

base_3[base_3$belongparty==0,]$belongparty <- NA
base_3[base_3$belongunion==0,]$belongunion <- NA
base_3[base_3$belongreligiousgroup==0,]$belongreligiousgroup <- NA

base_3[base_3$belongparty %in% 2,]$belongparty <- 0
base_3[base_3$belongunion %in% 2,]$belongunion <- 0
base_3[base_3$belongreligiousgroup %in% 2,]$belongreligiousgroup <- 0

#44.- (TARJETA 11) En una escala del 1 al 10, donde 1 significa “nada” y 10 “mucho”. ¿A usted...? (LEER) (0=NS/NC)
#a. Cuánto le interesa la política
base_3$interestpolitics <- base_3$P44_1
#c. Cuánto participa usted en las elecciones
base_3$interestelections <- base_3$P44_2
#e. Cuánto habla usted de asuntos políticos con otras personas
base_3$discusspolitics <- base_3$P44_5
#d. Cuánto sigue las noticias sobre política y gobierno
base_3$follownews <- base_3$P44_4

#54.- En general, ¿usted aprueba o desaprueba la forma como está haciendo su trabajo...? (1= Aprueba; 2=Desaprueba; 0=NS/NC)
base_3$presidentialapp <- base_3$P54_1
base_3$govapp <- base_3$P54_2
base_3$congressapp <- base_3$P54_4

base_3[base_3$presidentialapp==0,]$presidentialapp <- NA
base_3[base_3$govapp==0,]$govapp <- NA
base_3[base_3$congressapp==0,]$congressapp <- NA

base_3[base_3$presidentialapp %in% 2,]$presidentialapp <- 0
base_3[base_3$govapp %in% 2,]$govapp <- 0
base_3[base_3$congressapp %in% 2,]$congressapp <- 0

#87.- Generalmente, ¿usted se considera priísta, panista o perredista? (INSISTIR) ¿Muy (PRIISTA / PANISTA / PERREDISTA) o algo (PRIISTA / PANISTA /PERREDISTA)? (NS/NC=0)
base_3$partyid <- base_3$P87
base_3$pri <- ifelse(base_3$partyid == 1 | base_3$partyid == 2, 1, 0)
base_3$pan <- ifelse(base_3$partyid == 3 | base_3$partyid == 4, 1, 0)
base_3$prd <- ifelse(base_3$partyid == 5 | base_3$partyid == 6, 1, 0)

base_3$partyid <- ifelse(base_3$P87 == 1 | base_3$P87 == 2, 1, ifelse(base_3$P87 == 3 | base_3$P87 == 4, 2, ifelse(base_3$P87 == 5 | base_3$P87 == 6, 3, 0)))

base_3$education <-  ifelse(base_3$P104 == 1, 0, ifelse(base_3$P104 == 2, 1, ifelse(base_3$P104 == 3, 2, ifelse(base_3$P104 == 4 | base_3$P104 == 5, 3, ifelse(base_3$P104 == 6 | base_3$P104 == 7, 4, ifelse(base_3$P104 == 8, 5, ifelse(base_3$P104 == 9, 6, NA)))))))

base_3$cellphone <-  ifelse(base_3$P112_2 == 3, NA, base_3$P112_2)

base_3$internet <-  ifelse(base_3$P112_3 == 3, NA, base_3$P112_3)

# Consider replicate by distance, not prox
base_3$prox <- 1/base_3$distance

base_3$munID <- as.numeric(paste(base_3$estado, base_3$municipio, sep = ""))

```

```{r model_figure_1}

# I use multinom from nnet here
# Is constant term needed?
m1_3_multinom <- multinom(partyid ~ prox+edad+gender+education+sec+cellphone+internet+localidae, data = base_3)

summary(m1_3_multinom)

formula_presi <- presidentialapp ~ prox+edad+gender+education+sec+cellphone+internet+localidae
m4_presi <- glm(formula_presi, data = base_3, family = "binomial")

summary(m4_presi)

formula_gov <- govapp ~ prox+edad+gender+education+sec+cellphone+internet+localidae
m5_gov <- glm(formula_gov, data = base_3, family = "binomial")

summary(m5_gov)

formula_congress <- congressapp ~ prox+edad+gender+education+sec+cellphone+internet+localidae
m6_congress <- glm(formula_congress, data = base_3, family = "binomial")

summary(m6_congress)

# Seemingly Unrelated Regression by systemfit
# which result to trust, single regress or SUR?

sur_part1 <- systemfit(list(presi = formula_presi, gov = formula_gov, congress = formula_congress), method = "SUR", data = base_3)

summary(sur_part1)

formula_party <- belongparty ~ prox+edad+gender+education+sec+cellphone+internet+localidae
m7_party <- glm(formula_party, data = base_3, family = "binomial")

summary(m7_party)

formula_union <- belongunion ~ prox+edad+gender+education+sec+cellphone+internet+localidae
m8_union <- glm(formula_union, data = base_3, family = "binomial")

summary(m8_union)

formula_reli <- belongreligiousgroup ~ prox+edad+gender+education+sec+cellphone+internet+localidae
m9_reli <- glm(formula_reli, data = base_3, family = "binomial")

summary(m9_reli)

# Seemingly Unrelated Regression by systemfit
# which result to trust, single regress or SUR?

sur_part2 <- systemfit(list(party = formula_party, union = formula_union, reli = formula_reli), data = base_3)

summary(sur_part2)

# The last four formula are purely estimated by SUR
# Maybe replicate by regressing all formula separately?

formula_interestpoli <- interestpolitics ~ prox+edad+gender+education+sec+cellphone+internet+localidae

formula_interestelec <- interestelections ~ prox+edad+gender+education+sec+cellphone+internet+localidae

formula_discuss <- discusspolitics ~ prox+edad+gender+education+sec+cellphone+internet+localidae

formula_follow <- follownews ~ prox+edad+gender+education+sec+cellphone+internet+localidae

sur_part3 <- systemfit(list(interestpoli = formula_interestpoli, interestelec = formula_interestelec, discuss = formula_discuss, follow = formula_follow), data = base_3)

summary(sur_part3)

```

I rewrite the Stata code to R here, and compare the results in R, Stata, and in the paper. 

First, for the binomial and multinomial models (i.e., models starting with "m"), the R and Stata replication results are generally the same.

Second, the coefficients for "prox" in the replications' binomial and multinomial models are slightly different from those in the original paper. For instance, the coefficients for party IDs (i.e., the first three lines) are -0.053, 0.013, and -0.102 in Table B.2 in the paper's appendix. However, R and Stata replication generates -0.055, 0.019, and -0.102 separately. 

Third, the significance of the Figure 1's results generally remain the same in replications.

Fourth, the Seemingly Unrelated Regression (SUR) results are quite different in R and Stata. Although still non-significant, the coefficients differ a lot. I attach all coefficients (in the paper and in the R replication) below.

```{r graph_figure_1}

results <- read.table(header=T, con <- textConnection('
IV	Coefficient	StdError Coef_repli SE_repli	Model	Included	Variable Order
Proximity	-0.052	0.100	-0.055 0.101 1	1	PRI 13
Proximity  0.013	0.127	0.019 0.127 1	1	PAN 12
Proximity  -0.102  0.140	-0.102 0.141 1	1	PRD 11
Proximity  0.074	0.071	0.018 0.017 2	1	"President\'s Approval" 10
Proximity  -0.090	0.074	-0.023 0.017 2	1	"Governor\'s Approval" 9
Proximity  -0.039  0.073	0.008 0.016 2	1	"Congress\'s Approval" 8
Proximity  -0.546  0.398	-0.004 0.005 3	1	"Party Member" 7
Proximity  -0.047	0.147	-0.001 0.005 3	1	"Union Member" 6
Proximity  0.055  0.145	0.002 0.008 3	1	"Religious group member" 5
Proximity  -0.017  0.086  -0.015 0.086 4	1	"Interest in politics" 4
Proximity  -0.087	0.078	-0.081 0.079 4	1	"Interest in elections" 3
Proximity  0.105 0.080	0.109 0.081 4	1	"Talks about politcs" 2
Proximity  0.014  0.085  0.015 0.085 4	1	"Follows news" 1
'))
close(con)

results$min<-results$Coefficient-(1.96*results$StdError)
results$max<-results$Coefficient+(1.96*results$StdError)
results$Color[results$Included==1]<-"black"
results$Color[results$Included==0]<-"white"

results$Model[results$Model==1]<-"1. Party ID"
results$Model[results$Model==2]<-"2. Approval"
results$Model[results$Model==3]<-"3. Membership"
results$Model[results$Model==4]<-"4. Political Awareness"

results$Variable <- factor(results$Variable, levels=results$Variable[order(results$Order)])

results$min_repli<-results$Coef_repli-(1.96*results$SE_repli)
results$max_repli<-results$Coef_repli+(1.96*results$SE_repli)

# a is the figure 1 with original data; I am still trying to combine them into one # so that comparison is possible
a<-ggplot(results, aes(y=reorder(Variable, Order), x = Coefficient)) +
#  scale_colour_gradient(low="white", high="black")+
  geom_point(size=3) +
  facet_grid( ~ Model)+
  geom_errorbarh(aes(xmin=min, xmax=max),  height = 0) +
  geom_vline(xintercept = 0, linetype=2, color="red") +
  labs( x = "Coefficients", y = "Variable") +
  theme_bw()+
  theme(
    axis.title.x = element_text(face="bold", size=18),
    axis.title.y = element_text(face="bold", size=18, angle=90),
    axis.text.x  = element_text( size=16),
    strip.text.x = element_text(size=16),
    axis.text.y  = element_text( size=18))

a

# b is the figure 1 with replicated data
b<-ggplot(results, aes(y=reorder(Variable, Order), x = Coef_repli)) +
#  scale_colour_gradient(low="white", high="black")+
  geom_point(size=3) +
  facet_grid( ~ Model)+
  geom_errorbarh(aes(xmin=min_repli, xmax=max_repli), color = "blue")+
  geom_vline(xintercept = 0, linetype=2, color="red") +
  labs( x = "Coefficients", y = "Variable") +
  theme_bw()+
  theme(
    axis.title.x = element_text(face="bold", size=18),
    axis.title.y = element_text(face="bold", size=18, angle=90),
    axis.text.x  = element_text( size=16),
    strip.text.x = element_text(size=16),
    axis.text.y  = element_text( size=18))

b

```
# Replication of Table 1 (Frances)

I've mostly annotated and re-run the pre-existing code. I plan to go *back* through and re-do as simulations similar to how we were shown in section.

```{r}
data <- table
head(table)

#this is a function to round to the hundreds place of a decimal
specify_decimal <- function(x, k) {format(round(x, k), nsmall = k)}
```

These are models creating benchmark OLS estimates for proximity to Soriana stores on vote share:  

```{r}
#regressing different parties on proximity to soriana store 
robustness1 <- ols(proximity ~ PRI06 +PRD06+PAN06+PART06, data= data, x= TRUE, y= TRUE)
```


```{r}
#this is the same as the first but incorporating the municipal districts. 
robustness2 <- ols( proximity ~ PRI06+PRD06+PAN06+PART06+
                      id_mun, data=data, x=TRUE, y=TRUE)
```


```{r}
#this is the larger model
robustness3 <- ols( proximity ~ PRI06+PRD06+PAN06+PART06+
                      lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                      EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                      PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                      PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                      CAR+CELULAR+INTERNET+
                     id_mun, data=data, x=TRUE, y=TRUE)
```


```{r}
robustness4 <- ols( proximity ~ 
                      lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                      EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                      PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                      PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                      CAR+CELULAR+INTERNET+
                      id_mun, data=data, x=TRUE, y=TRUE)
```


This creates a table of covariates

```{r}
stargazer(robustness1, robustness2, robustness3, robustness4, star.cutoffs = c(0.05, 0.01, 0.001), style = "qje", digits=3,
          covariate.labels = c("PRI 2006", "PRD2006", "PAN2006", "Turnout 2006","Population Log", "Population over 18 ",
                               "Population over 65", "Area", "Density", "Indigenous","Catholic","Nonreligious","Education","College degree","Illiteracy","Inhabitants per house","Population in the labor market",
                               "Female population in the labor market", "No insurance","Female head of household","Inhabitants per room", "Dirt floor", "All services", "No services", "Car", "Mobile phone", "Internet", "ACULCO" , "ALMOLOYA DE JUAREZ " , 
                               "ALMOLOYA DEL RIO" , "AMANALCO" , "AMECAMECA" , "APAXCO" , "ATENCO" , "ATIZAPAN" , "ATIZAPAN DE ZARAGOZA" , "AXAPUSCO" , "AYAPANGO" , "CALIMAYA" , "CAPULHUAC" , "CHALCO" , "CHAPULTEPEC" ,
                               "CHIAUTLA" , "CHICOLOAPAN" , "CHICONCUAC" , "CHIMALHUACAN" , "COACALCO DE BERRIOZABAL" , "COCOTITLAN" , "COYOTEPEC" , "CUAUTITLAN" , "CUAUTITLAN IZCALLI" , "ECATEPEC DE MORELOS" , "HUEHUETOCA",
                               "HUEYPOXTLA" , "HUIXQUILUCAN" , "ISIDRO FABELA" , "IXTAPALUCA" , "IXTLAHUACA" , "JALTENCO" , "JILOTEPEC" , "JILOTZINGO" , "JIQUIPILCO" , "JOCOTITLAN" , "JOQUICINGO" , "JUCHITEPEC" , "LA PAZ" ,
                               "LERMA" , "MELCHOR OCAMPO" , "METEPEC" , "MEXICALTZINGO" , "MORELOS" , "NAUCALPAN DE JUAREZ" , "NEXTLALPAN" , "NEZAHUALCOYOTL" , "NICOLAS ROMERO" , "OCOYOACAC" , "OCUILAN" , "OTUMBA" , 
                               "OTZOLOTEPEC" , "PAPALOTLA" , "POLOTITLAN" , "RAYON" , "SAN ANTONIO LA ISLA" , "SAN FELIPE DEL PROGRESO" , "SAN MARTIN DE LAS PIRAMIDES" , "SAN MATEO ATENCO" , "SOYANIQUILPAN DE JUAREZ" , "TECAMAC" ,
                               "TEMAMATLA" , "TEMASCALAPA" , "TEMOAYA" , "TENANGO DEL AIRE" , "TENANGO DEL VALLE" , "TEOLOYUCAN" , "TEOTIHUACAN" , "TEPETLAOXTOC" , "TEPOTZOTLAN" , "TEQUIXQUIAC" , "TEXCALYACAC" , "TEXCOCO" , "TEZOYUCA" ,
                               "TIANGUISTENCO" , "TLALMANALCO" , "TLALNEPANTLA DE BAZ" , "TOLUCA" , "TONANITLA" , "TULTEPEC" , "TULTITLAN" , "VALLE DE CHALCO SOLIDARIDAD" , "VILLA DE ALLEND" , "VILLA DEL CARBON" , "VILLA VICTORIA" , 
                               "XALATLACO" , "XONACATLAN" , "ZINACANTEPEC" , "ZUMPANGO" , "ALVARO OBREGON" , "AZCAPOTZALCO" , "BENITO JUAREZ" , "COYOACAN" , "CUAJIMALPA DE MORELOS" , "CUAUHTEMOC" , "GUSTAVO A. MADERO" , "IZTACALCO" , 
                               "IZTAPALAPA" , "MAGDALENA CONTRERAS" , "MIGUEL HIDALGO" , "MILPA ALTA" , "TLAHUAC" , "TLALPAN" , "VENUSTIANO CARRANZA" , "XOCHIMILCO"))
```

This creates the Benchmark Model table from page 24 of the appendix. 
This is the basis of Table 1. 
```{r}
#reclassifying municipality and district as factor variables
data$id_mun<-factor(data$id_mun)
data$id_dist<-factor(data$id_dist)
```


```{r}
#empty matrices to take the slopes and standard errors of this benchmark model
slopesBM<-matrix(NA,3,4)
seBM<-matrix(NA,3,4)


benchmarkPRI.1 <- lm( EPNa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=data, x=TRUE, y=TRUE)
```

This function "returns a multi-way cluster-robust variance-covariance matrix" -- I think this bit right here is related to what Gary was saying on the type of errors and that they can cover up problems with the model. I don't fully understand this right now, but perhaps after we get a little further in the semester. 
```{r}
covBMpri <- cluster.vcov(benchmarkPRI.1, data$id_dist)

#t test
coeftest(benchmarkPRI.1, covBMpri)
```


```{r}
g_pri <- function(b){
  return( b[2] + b[139] + b[140] + b[146] )
}

g_prd <- function(b){
  return( b[2] + b[140] + b[142] + b[147] )
}

g_pan <- function(b){
  return( b[2] + b[140] + b[144] + b[148] )
}

#again, not very sure what this jacobian function is doing
grad_g_pri <-  jacobian(g_pri, benchmarkPRI.1$coef)
grad_g_prd <-  jacobian(g_prd, benchmarkPRI.1$coef)
grad_g_pan <-  jacobian(g_pan, benchmarkPRI.1$coef)
```

Taking the slopes and standard errors:
```{r}
slopesBM[1,1] <- benchmarkPRI.1$coefficients[c("proximity")] + benchmarkPRI.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPRI.1$coefficients[c("proximity:PRIstr")]+  benchmarkPRI.1$coefficients[c("proximity:PRIstr:highTURNOUT")]

slopesBM[2,1] <- benchmarkPRI.1$coefficients[c("proximity")] + benchmarkPRI.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPRI.1$coefficients[c("proximity:PRDstr")]+  benchmarkPRI.1$coefficients[c("proximity:highTURNOUT:PRDstr")]

slopesBM[3,1] <- benchmarkPRI.1$coefficients[c("proximity")] + benchmarkPRI.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPRI.1$coefficients[c("proximity:PANstr")]+  benchmarkPRI.1$coefficients[c("proximity:highTURNOUT:PANstr")]

seBM[1,1]<-sqrt(grad_g_pri%*% covBMpri %*% t(grad_g_pri))

seBM[2,1]<-sqrt(grad_g_prd%*% covBMpri %*% t(grad_g_prd))

seBM[3,1]<-sqrt(grad_g_pan%*% covBMpri %*% t(grad_g_pan))
```


The same model for AMLO and the other parties: 
```{r}
benchmarkPRD.1 <- lm( AMLOa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=data, x=TRUE, y=TRUE)

covBMprd <- cluster.vcov(benchmarkPRD.1, data$id_dist)

coeftest(benchmarkPRD.1, covBMprd)

g_pri <- function(b){
  return( b[2] + b[139] + b[140] + b[146] )
}

g_prd <- function(b){
  return( b[2] + b[140] + b[142] + b[147] )
}

g_pan <- function(b){
  return( b[2] + b[140] + b[144] + b[148] )
}

grad_g_pri <-  jacobian(g_pri, benchmarkPRD.1$coef)
grad_g_prd <-  jacobian(g_prd, benchmarkPRD.1$coef)
grad_g_pan <-  jacobian(g_pan, benchmarkPRD.1$coef)


slopesBM[1,2] <- benchmarkPRD.1$coefficients[c("proximity")] + benchmarkPRD.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPRD.1$coefficients[c("proximity:PRIstr")]+  benchmarkPRD.1$coefficients[c("proximity:PRIstr:highTURNOUT")]
slopesBM[2,2] <- benchmarkPRD.1$coefficients[c("proximity")] + benchmarkPRD.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPRD.1$coefficients[c("proximity:PRDstr")]+  benchmarkPRD.1$coefficients[c("proximity:highTURNOUT:PRDstr")]
slopesBM[3,2] <- benchmarkPRD.1$coefficients[c("proximity")] + benchmarkPRD.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPRD.1$coefficients[c("proximity:PANstr")]+  benchmarkPRD.1$coefficients[c("proximity:highTURNOUT:PANstr")]
seBM[1,2]<-sqrt(grad_g_pri%*% covBMprd %*% t(grad_g_pri))
seBM[2,2]<-sqrt(grad_g_prd%*% covBMprd %*% t(grad_g_prd))
seBM[3,2]<-sqrt(grad_g_pan%*% covBMprd %*% t(grad_g_pan))


benchmarkPAN.1 <- lm( JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=data, x=TRUE, y=TRUE)

covBMpan <- cluster.vcov(benchmarkPAN.1, data$id_dist)

coeftest(benchmarkPAN.1, covBMpan)

g_pri <- function(b){
  return( b[2] + b[139] + b[140] + b[146] )
}

g_prd <- function(b){
  return( b[2] + b[140] + b[142] + b[147] )
}

g_pan <- function(b){
  return( b[2] + b[140] + b[144] + b[148] )
}

grad_g_pri <-  jacobian(g_pri, benchmarkPAN.1$coef)
grad_g_prd <-  jacobian(g_prd, benchmarkPAN.1$coef)
grad_g_pan <-  jacobian(g_pan, benchmarkPAN.1$coef)


slopesBM[1,3] <- benchmarkPAN.1$coefficients[c("proximity")] + benchmarkPAN.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPAN.1$coefficients[c("proximity:PRIstr")]+  benchmarkPAN.1$coefficients[c("proximity:PRIstr:highTURNOUT")]
slopesBM[2,3] <- benchmarkPAN.1$coefficients[c("proximity")] + benchmarkPAN.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPAN.1$coefficients[c("proximity:PRDstr")]+  benchmarkPAN.1$coefficients[c("proximity:highTURNOUT:PRDstr")]
slopesBM[3,3] <- benchmarkPAN.1$coefficients[c("proximity")] + benchmarkPAN.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPAN.1$coefficients[c("proximity:PANstr")]+  benchmarkPAN.1$coefficients[c("proximity:highTURNOUT:PANstr")]
seBM[1,3]<-sqrt(grad_g_pri%*% covBMpan %*% t(grad_g_pri))
seBM[2,3]<-sqrt(grad_g_prd%*% covBMpan %*% t(grad_g_prd))
seBM[3,3]<-sqrt(grad_g_pan%*% covBMpan %*% t(grad_g_pan))


benchmarkPART.1 <- lm( PART ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=data, x=TRUE, y=TRUE)

covBMpart <- cluster.vcov(benchmarkPART.1, data$id_dist)

coeftest(benchmarkPART.1, covBMpart)

g_pri <- function(b){
  return( b[2] + b[139] + b[140] + b[146] )
}

g_prd <- function(b){
  return( b[2] + b[140] + b[142] + b[147] )
}

g_pan <- function(b){
  return( b[2] + b[140] + b[144] + b[148] )
}

grad_g_pri <-  jacobian(g_pri, benchmarkPART.1$coef)
grad_g_prd <-  jacobian(g_prd, benchmarkPART.1$coef)
grad_g_pan <-  jacobian(g_pan, benchmarkPART.1$coef)

slopesBM[1,4] <- benchmarkPART.1$coefficients[c("proximity")] + benchmarkPART.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPART.1$coefficients[c("proximity:PRIstr")]+  benchmarkPART.1$coefficients[c("proximity:PRIstr:highTURNOUT")]
slopesBM[2,4] <- benchmarkPART.1$coefficients[c("proximity")] + benchmarkPART.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPART.1$coefficients[c("proximity:PRDstr")]+  benchmarkPART.1$coefficients[c("proximity:highTURNOUT:PRDstr")]
slopesBM[3,4] <- benchmarkPART.1$coefficients[c("proximity")] + benchmarkPART.1$coefficients[c("proximity:highTURNOUT")] + benchmarkPART.1$coefficients[c("proximity:PANstr")]+  benchmarkPART.1$coefficients[c("proximity:highTURNOUT:PANstr")]

seBM[1,4]<-sqrt(grad_g_pri%*% covBMpart %*% t(grad_g_pri))
seBM[2,4]<-sqrt(grad_g_prd%*% covBMpart %*% t(grad_g_prd))
seBM[3,4]<-sqrt(grad_g_pan%*% covBMpart %*% t(grad_g_pan))
```

Table 1: 
```{r}
stargazer(coeftest(benchmarkPRI.1, covBMpri), coeftest(benchmarkPRD.1, covBMprd), coeftest(benchmarkPAN.1, covBMpan), coeftest(benchmarkPART.1, covBMpart),style = "qje", star.cutoffs = c(0.05, 0.01, 0.001), digits=3,
          covariate.labels = c("Proximity", "PRI stronghold", "High Mobilization", "PRD stronghold","PAN stronghold", "PRI 2009", "PRD2009", "PAN2009", "Turnout 2009", "Population Log", "Population over 18 ",
                               "Population over 65", "Area", "Density", "Indigenous","Catholic","Nonreligious","Education","College degree","Illiteracy","Inhabitants per house","Population in the labor market",
                               "Female population in the labor market", "No insurance","Female head of household","Inhabitants per room", "Dirt floor", "All services", "No services", "Car", "Mobile phone", "Internet", "ACULCO" , "ALMOLOYA DE JUAREZ " , 
                               "ALMOLOYA DEL RIO" , "AMANALCO" , "AMECAMECA" , "APAXCO" , "ATENCO" , "ATIZAPAN" , "ATIZAPAN DE ZARAGOZA" , "AXAPUSCO" , "AYAPANGO" , "CALIMAYA" , "CAPULHUAC" , "CHALCO" , "CHAPULTEPEC" ,
                               "CHIAUTLA" , "CHICOLOAPAN" , "CHICONCUAC" , "CHIMALHUACAN" , "COACALCO DE BERRIOZABAL" , "COCOTITLAN" , "COYOTEPEC" , "CUAUTITLAN" , "CUAUTITLAN IZCALLI" , "ECATEPEC DE MORELOS" , "HUEHUETOCA",
                               "HUEYPOXTLA" , "HUIXQUILUCAN" , "ISIDRO FABELA" , "IXTAPALUCA" , "IXTLAHUACA" , "JALTENCO" , "JILOTEPEC" , "JILOTZINGO" , "JIQUIPILCO" , "JOCOTITLAN" , "JOQUICINGO" , "JUCHITEPEC" , "LA PAZ" ,
                               "LERMA" , "MELCHOR OCAMPO" , "METEPEC" , "MEXICALTZINGO" , "MORELOS" , "NAUCALPAN DE JUAREZ" , "NEXTLALPAN" , "NEZAHUALCOYOTL" , "NICOLAS ROMERO" , "OCOYOACAC" , "OCUILAN" , "OTUMBA" , 
                               "OTZOLOTEPEC" , "PAPALOTLA" , "POLOTITLAN" , "RAYON" , "SAN ANTONIO LA ISLA" , "SAN FELIPE DEL PROGRESO" , "SAN MARTIN DE LAS PIRAMIDES" , "SAN MATEO ATENCO" , "SOYANIQUILPAN DE JUAREZ" , "TECAMAC" ,
                               "TEMAMATLA" , "TEMASCALAPA" , "TEMOAYA" , "TENANGO DEL AIRE" , "TENANGO DEL VALLE" , "TEOLOYUCAN" , "TEOTIHUACAN" , "TEPETLAOXTOC" , "TEPOTZOTLAN" , "TEQUIXQUIAC" , "TEXCALYACAC" , "TEXCOCO" , "TEZOYUCA" ,
                               "TIANGUISTENCO" , "TLALMANALCO" , "TLALNEPANTLA DE BAZ" , "TOLUCA" , "TONANITLA" , "TULTEPEC" , "TULTITLAN" , "VALLE DE CHALCO SOLIDARIDAD" , "VILLA DE ALLEND" , "VILLA DEL CARBON" , "VILLA VICTORIA" , 
                               "XALATLACO" , "XONACATLAN" , "ZINACANTEPEC" , "ZUMPANGO" , "ALVARO OBREGON" , "AZCAPOTZALCO" , "BENITO JUAREZ" , "COYOACAN" , "CUAJIMALPA DE MORELOS" , "CUAUHTEMOC" , "GUSTAVO A. MADERO" , "IZTACALCO" , 
                               "IZTAPALAPA" , "MAGDALENA CONTRERAS" , "MIGUEL HIDALGO" , "MILPA ALTA" , "TLAHUAC" , "TLALPAN" , "VENUSTIANO CARRANZA" , "XOCHIMILCO"))


```


Re-doing Table 1 using simulation/how shown in Section 7:
```{r}
#regressing different parties on proximity to soriana store 
benchmarkPRI.1 <- lm( EPNa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=data, x=TRUE, y=TRUE)

benchmarkPRD.1 <- lm( AMLOa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=data, x=TRUE, y=TRUE)

benchmarkPAN.1 <- lm( JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                         PRI09a+PRD09a+PAN09a+PART09+
                         lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                         EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                         PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                         PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                         CAR+CELULAR+INTERNET+
                         id_mun, data=data, x=TRUE, y=TRUE)

benchmarkPART.1 <- lm( PART ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
                          PRI09a+PRD09a+PAN09a+PART09+
                          lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
                          EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
                          PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
                          PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
                          CAR+CELULAR+INTERNET+
                          id_mun, data=data, x=TRUE, y=TRUE)
```


Simulation: 
```{r}
sim_coeff <- function(coeff, vcov){
  return(mvtnorm::rmvnorm(1, mean = coeff, sigma = vcov))
}
```

```{r}
prox <- seq(0, 100, by = .5)

data %>%
  summarise(proximity = median(proximity), PRIstr = median(PRIstr ), highTURNOUT = median(highTURNOUT), PRDstr = median(PRDstr),PANstr = median(PANstr), PRI09a = median(PRI09a), PRD09a = median(PRD09a), PAN09a= median(PAN09a), PART09= median(PART09),
                          lnpop= median(lnpop), P18= median(P18), P65= median(P65), area= median(area), density= median(density), INDIGENOUS= median(INDIGENOUS), CATHOLIC= median(CATHOLIC), NONRELIGIOUS= median(NONRELIGIOUS),
                          EDUCATION= median(EDUCATION), POSTEDUC= median(POSTEDUC), ILLITERACY= median(ILLITERACY), PROM_HNV= median(PROM_HNV),
                          PEAprop= median(PEAprop), PEAfemale= median(PEAfemale), NOINSURANCE= median(NOINSURANCE), FEMALEJEFA= median(FEMALEJEFA),
                          PERROOM= median(PERROOM),DIRTFLOOR= median(DIRTFLOOR),SERVICES= median(SERVICES) ,NO_SERVICES = median(NO_SERVICES),
                          CAR= median(CAR),CELULAR= median(CELULAR),INTERNET= median(INTERNET)
)-> med 
```


```{r}

tibble(PRIstr = rep(med$PRIstr, length (prox)), 
       highTURNOUT= rep(med$highTURNOUT, length (prox)), 
       PRDstr= rep(med$PRDstr, length (prox)), 
       PANstr= rep(med$PANstr, length (prox)), 
       PRI09a= rep(med$PRI09a, length (prox)), 
       PAN09a= rep(med$PAN09a, length (prox)),
       PART09= rep(med$PART09, length (prox)),
       PRD09a= rep(med$PRD09a, length (prox)),
       lnpop= rep(med$lnpop, length (prox)),
       P18= rep(med$P18, length (prox)),
       P65= rep(med$P65, length (prox)),
     area= rep(med$area, length (prox)),
     density= rep(med$density, length (prox)),
     INDIGENOUS= rep(med$INDIGENOUS, length (prox)),
     CATHOLIC= rep(med$CATHOLIC, length (prox)),
     NONRELIGIOUS = rep(med$NONRELIGIOUS, length (prox)),
      EDUCATION = rep( med$EDUCATION, length (prox)),
              POSTEDUC = rep(med$POSTEDUC, length (prox)),
               ILLITERACY = rep(med$ILLITERACY, length (prox)),
               PROM_HNV = rep(med$PROM_HNV , length (prox)),
                 PEAprop= rep(med$PEAprop , length (prox)),
                  PEAfemale = rep(med$PEAfemale , length (prox)),
                 NOINSURANCE = rep(med$NOINSURANCE , length (prox)),
                   FEMALEJEFA = rep(med$FEMALEJEFA, length (prox)),
                     PERROOM= rep( med$PERROOM, length (prox)),   
    DIRTFLOOR= rep(med$DIRTFLOOR, length (prox)),                   
       SERVICES= rep(med$SERVICES, length (prox)),   
  NO_SERVICES= rep(med$NO_SERVICES, length (prox)),   
     CAR= rep(med$CAR, length (prox)),   
CELULAR= rep(med$CELULAR, length (prox)),   
INTERNET= rep(med$INTERNET, length (prox)),   
) %>% 
  arrange(PRIstr, highTURNOUT, PRDstr, PANstr, PRI09a, PRD09a, PAN09a, PART09,
                          lnpop, P18, P65, area, density, INDIGENOUS, CATHOLIC, NONRELIGIOUS,
                          EDUCATION, POSTEDUC, ILLITERACY, PROM_HNV,
                          PEAprop, PEAfemale, NOINSURANCE, FEMALEJEFA,
                          PERROOM,DIRTFLOOR,SERVICES,NO_SERVICES,
                          CAR,CELULAR,INTERNET) -> data_sim
```


```{r}
#simulating coefficients from lm
coeff_sim <- sim_coeff(benchmarkPRI.1$coefficients, vcov(benchmarkPRI.1))
```

Really not sure on this... something is breaking down in the matrix multiplication.
```{r}
#simulating y and calculating the QOI 
sim_E <- function(data_sim, coeff_sim){
  mu <- mean(coeff_sim)
  sd <- sqrt(var(coeff_sim))
  Xbeta <- cbind(1, as.matrix(data_sim)) %*% as.matrix(coeff_sim)
  Y <- Xbeta + rnorm(length(prox), mean = mu, sd = sd)
}
```


```{r}
sim_run <- function(fit, data_sim){
  coeff_sim <- sim_coeff(fit$coefficients, vcov(fit))
  EY_sim <- sim_E(data_sim, coeff_sim)
  return(EY_sim)
}

sim_run(benchmarkPRI.1, data_sim)
```




## Table 2
```{r}
BM<-matrix(NA,6,4)

for(j in 1:4){
  BM[1,j]<-specify_decimal(slopesBM[1,j], 3)
  BM[2,j]<-paste("(",specify_decimal(seBM[1,j], 3),")", sep="")
  BM[3,j]<-specify_decimal(slopesBM[2,j], 3)
  BM[4,j]<-paste("(",specify_decimal(seBM[2,j], 3),")", sep="")
  BM[5,j]<-specify_decimal(slopesBM[3,j], 3)
  BM[6,j]<-paste("(",specify_decimal(seBM[3,j], 3),")", sep="")
}

xtable(BM)
```

## Figure 2
```{r}
####Predicted vote shares in PRD Mobilized Strongholds

g <- glm(EPNa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=data, family = 'gaussian')

at.prox <- seq(1/20, 1/2.5, 1/1000)
marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=data[data$PRDstr==1 & data$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000),  cofint=.95)

#getting confidence intervals for the expected PN turnout in PRD strongholds
mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRI<-data.frame(cbind(at.prox, mean, upper, lower))
dataPRI$distance<-(1/dataPRI$at.prox)


#same for AMLO
g <- glm(AMLOa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=data, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=data[data$PRDstr==1 & data$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000), cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPRD<-data.frame(cbind(at.prox, mean, upper, lower))
dataPRD$distance<-(1/dataPRD$at.prox)


g <- glm(JVMa ~ proximity*PRIstr*highTURNOUT+proximity*PRDstr*highTURNOUT+proximity*PANstr*highTURNOUT+     
           PRI09a+PRD09a+PAN09a+PART09+
           lnpop+P18+P65+area+density+INDIGENOUS+CATHOLIC+NONRELIGIOUS+
           EDUCATION+POSTEDUC+ILLITERACY+PROM_HNV+
           PEAprop+PEAfemale+NOINSURANCE+FEMALEJEFA+
           PERROOM+DIRTFLOOR+SERVICES+NO_SERVICES+
           CAR+CELULAR+INTERNET+
           id_mun, data=data, family = 'gaussian')

marg<-marg(mod = g, var_interest = c("proximity"), type = 'levels', data=data[data$PRDstr==1 & data$highTURNOUT==1,],
           at_var_interest = seq(1/20, 1/2.5, 1/1000),cofint=.95)

mean <- marg[[1]]$Margin
upper <- marg[[1]]$'Lower CI (95%)'
lower <- marg[[1]]$'Upper CI (95%)'

dataPAN<-data.frame(cbind(at.prox, mean, upper, lower))
dataPAN$distance<-(1/dataPAN$at.prox)

datasim<-data.frame(rbind(dataPRI, dataPRD, dataPAN))

datasim$dv<-NA
datasim$dv[1:351]<-"Peña Nieto"
datasim$dv[352:702]<-"López Obrador"
datasim$dv[703:1053]<-"Vázquez Mota"

ggplot()+
  geom_line(data=datasim, aes(x=distance, y=mean,  linetype=dv))+
  geom_ribbon(data=datasim, aes(x=distance,  ymin=lower, ymax=upper, fill=dv),  alpha=0.5)+theme_bw()+
  ylab("Predicted vote shares (%)")+
  xlab("Distance to Soriana (km)")+xlim(2.5,20)+ylim(0,50)+ 
  scale_fill_manual(values = c("#F0E442","red", "deepskyblue2"), name="")+
  scale_linetype_manual(values=c("solid", "longdash","dotted"), name="" )+
  theme(axis.text=element_text(size=18),
        axis.title=element_text(size=18),
        legend.text = element_text(size = 18))
```

